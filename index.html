<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Gaming Caf√© Leipzig</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body { margin: 0; font-family: Arial, sans-serif; background: linear-gradient(135deg, #0f0f0f, #1c1c1c); color: white; display: flex; justify-content: center; align-items: center; min-height: 100vh; text-align: center; padding: 20px; }
        .container { background: #1f1f1f; padding: 40px; border-radius: 15px; width: 90%; max-width: 560px; box-shadow: 0 0 25px rgba(0, 255, 150, 0.2); }
        h1 { margin-bottom: 10px; color: #00ff99; }
        p { opacity: 0.85; }
        .section { margin-top: 28px; padding-top: 22px; border-top: 1px solid rgba(255, 255, 255, 0.12); }
        input { width: 100%; padding: 12px; margin-top: 15px; border-radius: 8px; border: none; font-size: 16px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; margin-top: 12px; border-radius: 8px; border: none; background: #00ff99; color: black; font-weight: bold; cursor: pointer; font-size: 16px; }
        button:hover { background: #00cc77; }
        button:disabled { cursor: not-allowed; opacity: 0.6; background: #6e6e6e; color: #ddd; }
        .vote-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
        .vote-buttons button { margin-top: 0; }
        .success { margin-top: 15px; color: #00ff99; display: none; }
        .hint { margin-top: 10px; font-size: 14px; opacity: 0.8; display: none; }
        .contact a { color: #00ff99; text-decoration: none; font-weight: bold; }
        .contact a:hover { text-decoration: underline; }
        .admin-panel { display: none; text-align: left; background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 14px; margin-top: 12px; }
        .admin-panel ul { margin: 8px 0 0; padding-left: 20px; }
         .admin-panel li { margin-bottom: 6px; opacity: 0.95; }
        .server-warning { display:none; margin-top:14px; padding:10px; border-radius:8px; background:#4a1f1f; color:#ffd4d4; font-size:14px; text-align:left; }
    </style>
</head>
<body>
<div class="container">
    <h1>Gaming Caf√© Leipzig</h1>
    <p>Hilf uns, das Gaming Caf√© in Leipzig aufzubauen üöÄ</p>
    <div id="serverWarning" class="server-warning"></div>

    <div class="section">
        <p>Soll es in Leipzig ein Gaming Caf√© geben?</p>
        <div class="vote-buttons">
            <button id="voteYesBtn" onclick="vote('yes')">Ja üéÆ</button>
            <button id="voteNoBtn" onclick="vote('no')">Nein</button>
        </div>
        <div class="success" id="voteSuccessMsg">Danke f√ºr deine Stimme!</div>
        <div class="hint" id="voteLimitMsg">Du hast auf diesem Ger√§t bereits abgestimmt.</div>
    </div>

    <div class="section" id="gameSuggestionSection">
        <p>Welche Games sollen wir anbieten?</p>
        <input type="text" id="gameInput" placeholder="Dein Game-Vorschlag...">
        <button id="suggestionBtn" onclick="submitGame()">Vorschlag absenden</button>
        <div class="success" id="successMsg">Danke f√ºr deinen Vorschlag!</div>
        <div class="hint" id="suggestionLimitMsg">Du hast auf diesem Ger√§t bereits einen Vorschlag abgegeben.</div>
    </div>

    <div class="section">
        <p>Admin-Bereich</p>
        <div id="adminControls">
            <button id="openAdminBtn" onclick="openAdminPanel()">Admin-Ansicht √∂ffnen</button>
        </div>

        <div class="admin-panel" id="adminPanel">
            <p><strong>Voting (privat)</strong></p>
            <p id="adminVotes">Ja: 0 | Nein: 0</p>
            <p id="adminVoteTimestamp">Letzte Stimme: -</p>
            <p style="font-size:13px; opacity:0.75;">Hinweis: Votes und Vorschl√§ge sind jetzt zentral auf dem Server gespeichert.</p>
            <p><strong>Vorschl√§ge</strong></p>
            <ul id="adminSuggestions"></ul>
            <label style="display:block; margin-top:12px;">
                <input type="checkbox" id="adminTestModeToggle" onchange="toggleAdminTestMode()">
                Testmodus (Admin kann mehrfach voten & vorschlagen)
            </label>
            <button onclick="resetAllData()">Votes & Vorschl√§ge zur√ºcksetzen</button>
        </div>
    </div>

    <div class="section contact">
        <p>
            F√ºr Unterst√ºtzung oder Sponsoring erreichst du mich unter:<br>
            <a href="mailto:gamingcafe.lpz@gmail.com">gamingcafe.lpz@gmail.com</a>
        </p>
    </div>
</div>

<script>
const ADMIN_PASSWORD = "Nopeman11!";
let adminRefreshTimer = null;
let latestState = { votes: { yes: 0, no: 0 }, suggestions: [], lastVoteTimestamp: null, limitVersion: 1 };

ensureDeviceId();
initialize();

async function initialize() {
    try {
        await refreshState();
        hideServerWarning();
    } catch (error) {
        showServerWarning(error.message);
    }

    applyDeviceLimits();
    restoreAdminSession();
}

function ensureDeviceId() {
    if (!localStorage.getItem("deviceId")) {
        localStorage.setItem("deviceId", crypto.randomUUID());
    }
}

function getDeviceId() {
    return localStorage.getItem("deviceId");
}

function getLocalLimitVersion() {
    return Number(localStorage.getItem("limitVersion") || 0);
}

function setLocalLimitVersion(version) {
    localStorage.setItem("limitVersion", String(version));
}

function applyDeviceLimits() {
    const voteYesBtn = document.getElementById("voteYesBtn");
    const voteNoBtn = document.getElementById("voteNoBtn");
    const voteLimitMsg = document.getElementById("voteLimitMsg");
    const suggestionInput = document.getElementById("gameInput");
    const suggestionBtn = document.getElementById("suggestionBtn");
    const suggestionLimitMsg = document.getElementById("suggestionLimitMsg");

    const hasVoted = localStorage.getItem("hasVoted") === "true" && getLocalLimitVersion() === latestState.limitVersion;
    const hasSuggested = localStorage.getItem("hasSuggested") === "true" && getLocalLimitVersion() === latestState.limitVersion;

    if (hasVoted && !canBypassLimits()) {
        voteYesBtn.disabled = true;
        voteNoBtn.disabled = true;
        voteLimitMsg.style.display = "block";
    } else {
        voteYesBtn.disabled = false;
        voteNoBtn.disabled = false;
        voteLimitMsg.style.display = "none";
    }

    if (hasSuggested && !canBypassLimits()) {
        suggestionInput.disabled = true;
        suggestionBtn.disabled = true;
        suggestionLimitMsg.style.display = "block";
    } else {
        suggestionInput.disabled = false;
        suggestionBtn.disabled = false;
        suggestionLimitMsg.style.display = "none";
    }
}

function canBypassLimits() {
    return isAdminUnlocked() && sessionStorage.getItem("adminTestMode") === "true";
}

async function api(path, options = {}) {
    const response = await fetch(path, {
        method: options.method || "GET",
        headers: { "Content-Type": "application/json" },
        body: options.body ? JSON.stringify(options.body) : undefined,
    });

    const contentType = response.headers.get("content-type") || "";
    const isJson = contentType.includes("application/json");
    const data = isJson ? await response.json() : null;

    if (!isJson) {
        throw new Error("API nicht erreichbar: Pr√ºfe, ob der Node-Server l√§uft/deployed ist (nicht nur statisches Hosting).");
    }

    if (!response.ok) {
        throw new Error(data.error || "Fehler bei der Anfrage");
    }

    return data;
}

function showServerWarning(message) {
    const el = document.getElementById("serverWarning");
    el.textContent = message;
    el.style.display = "block";
}

function hideServerWarning() {
    const el = document.getElementById("serverWarning");
    el.style.display = "none";
    el.textContent = "";
}

async function refreshState() {
    latestState = await api("/api/state");
    if (getLocalLimitVersion() !== latestState.limitVersion) {
        localStorage.removeItem("hasVoted");
        localStorage.removeItem("hasSuggested");
        setLocalLimitVersion(latestState.limitVersion);
    }
    if (isAdminUnlocked()) {
        renderAdminData();
    }
}

async function submitGame() {
    const input = document.getElementById("gameInput");
    const success = document.getElementById("successMsg");
    const value = input.value.trim();

    if (!value) {
        alert("Bitte gib ein Spiel ein.");
        return;
    }

    try {
        await api("/api/suggest", {
            method: "POST",
            body: { suggestion: value, deviceId: getDeviceId(), force: canBypassLimits() }
        });
        localStorage.setItem("hasSuggested", "true");
        setLocalLimitVersion(latestState.limitVersion);
        input.value = "";
        success.style.display = "block";
        await refreshState();
        hideServerWarning();
        applyDeviceLimits();
    } catch (error) {
        document.getElementById("suggestionLimitMsg").style.display = "block";
        showServerWarning(error.message);
        alert(error.message);
    }
}

async function vote(type) {
    const voteSuccess = document.getElementById("voteSuccessMsg");

    try {
        await api("/api/vote", {
            method: "POST",
            body: { type, deviceId: getDeviceId(), force: canBypassLimits() }
        });
        localStorage.setItem("hasVoted", "true");
        setLocalLimitVersion(latestState.limitVersion);
        voteSuccess.style.display = "block";
        await refreshState();
        hideServerWarning();
        applyDeviceLimits();
    } catch (error) {
        document.getElementById("voteLimitMsg").style.display = "block";
        showServerWarning(error.message);
        alert(error.message);
    }
}

function openAdminPanel() {
    if (!isAdminUnlocked()) {
        const enteredPassword = window.prompt("Bitte Admin-Passwort eingeben:", "");
        if (enteredPassword === null) return;
        if (enteredPassword !== ADMIN_PASSWORD) {
            alert("Falsches Passwort.");
            return;
        }
        sessionStorage.setItem("adminUnlocked", "true");
    }

    hideAdminLoginControls();
    document.getElementById("adminPanel").style.display = "block";
    initializeAdminControls();
    renderAdminData();
    startAdminLiveRefresh();
}

function restoreAdminSession() {
    if (!isAdminUnlocked()) return;
    hideAdminLoginControls();
    document.getElementById("adminPanel").style.display = "block";
    initializeAdminControls();
    renderAdminData();
    startAdminLiveRefresh();
}

function hideAdminLoginControls() {
    document.getElementById("adminControls").style.display = "none";
}

function initializeAdminControls() {
    document.getElementById("adminTestModeToggle").checked = sessionStorage.getItem("adminTestMode") === "true";
}

function toggleAdminTestMode() {
    const checked = document.getElementById("adminTestModeToggle").checked;
    sessionStorage.setItem("adminTestMode", checked ? "true" : "false");
    applyDeviceLimits();
}

async function resetAllData() {
    try {
        await api("/api/reset", { method: "POST", body: { password: ADMIN_PASSWORD } });
        localStorage.removeItem("hasVoted");
        localStorage.removeItem("hasSuggested");
        await refreshState();
        hideServerWarning();
        document.getElementById("voteSuccessMsg").style.display = "none";
        document.getElementById("successMsg").style.display = "none";
        document.getElementById("gameInput").value = "";
        applyDeviceLimits();
    } catch (error) {
        showServerWarning(error.message);
        alert(error.message);
    }
}

function startAdminLiveRefresh() {
    if (adminRefreshTimer !== null) return;
    adminRefreshTimer = setInterval(async () => {
        try {
            await refreshState();
            hideServerWarning();
            applyDeviceLimits();
        } catch {
            showServerWarning("Server-Verbindung unterbrochen. Bitte Deployment/Server pr√ºfen.")
        }
    }, 1000);
}

function isAdminUnlocked() {
    return sessionStorage.getItem("adminUnlocked") === "true";
}

function renderAdminData() {
    document.getElementById("adminVotes").textContent = `Ja: ${latestState.votes.yes} | Nein: ${latestState.votes.no}`;
    document.getElementById("adminVoteTimestamp").textContent = `Letzte Stimme: ${formatTimestamp(latestState.lastVoteTimestamp)}`;

    const adminSuggestions = document.getElementById("adminSuggestions");
    adminSuggestions.innerHTML = "";
    if (latestState.suggestions.length === 0) {
        const li = document.createElement("li");
        li.textContent = "Noch keine Vorschl√§ge vorhanden.";
        adminSuggestions.appendChild(li);
        return;
    }

    latestState.suggestions.forEach((suggestion) => {
        const li = document.createElement("li");
        li.textContent = suggestion.text;
        adminSuggestions.appendChild(li);
    });
}

function formatTimestamp(value) {
    if (!value) return "-";
    return new Date(value).toLocaleString("de-DE", { dateStyle: "short", timeStyle: "medium" });
}
</script>
</body>
</html>
